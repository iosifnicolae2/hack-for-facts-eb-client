---
session_id: "3ffc7f2b-7cb7-4cd4-96fc-080caec3f701"
session_id_source: "provided"
created: "2026-01-13T21:25:06Z"
updated: "2026-01-13T23:00:18Z"
status: "committed"
commit: "b64f74a"
topic: ""
tags: []
project_dir: "/Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client"
cwd: "/Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client"
---

# Session Decisions: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701

## Decisions

### PROMPT: User input
**Time**: 2026-01-13T21:25:06Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T212506Z-UserPrompt-39720

@transparenta.eu.har I want you to investigate the entity lifecycle page. there is a very annoying flicker on the initial page load when forcing reload. What seems to be happening is that the page loads with the data from the server, but then it triggers a refetch of the same data for the entity details, which displays a skeleton loading component and then shows again the entity details. What I want to do is a way to transfer the state from the server side rendering to the client for entity d...

---

### USER: Currency
**Time**: 2026-01-13T22:33:54Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T223354Z-AskUserQuestion-72641-q1
**Context**: Currency
**Multi-select**: false

**Question**: If SSR uses a different currency than the client (e.g., SSR fetched in RON but client prefers EUR), we'd briefly show SSR numbers with possibly wrong currency context. How should we handle this?

**Options**:
1. **Accept brief mismatch** - Brief mismatch is better than skeleton flash. The background refetch will quickly fix it.
2. **Header-only placeholder** - Only use SSR data for currency-agnostic fields (name, CUI, address, entity_type). Let other sections load normally.
3. **Gate on matching currency** - Only use SSR placeholder if currency/normalization match client preferences. Show skeleton if they differ.

**Selected**: Accept brief mismatch

---

### PLAN: Plan: Fix Entity Details Flickering on Page Load
**Time**: 2026-01-13T22:34:29Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T223429Z-ExitPlanMode-74462-plan
**Plan created**: 2026-01-14T00:34:04Z
**Lines**: 165
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client

**Files**:
- Original: /Users/claudiuconstantinbogdan/.claude/plans/noble-swinging-newell.md
- Archived: .claude/plans/archived/noble-swinging-newell-20260113T223429Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client/.claude/plans/archived/noble-swinging-newell-20260113T223429Z.md

**Summary**:
I'll summarize the key decisions and approach from this implementation plan:

## Summary

- **Root Cause**: Query cache mismatch between SSR (using cookies) and client (using localStorage) for currency/preferences creates different query keys, causing skeleton flash on load

- **Solution**: Return minimal SSR params from loader, derive SSR entity from rehydrated queryClient cache in component, and use `placeholderData` function to show cached SSR data while background refetch happens

- **Changes**: Update 3 files (~20 lines total) - loader returns params, lazy component derives placeholder from cache, hook uses function-based `placeholderData` to preserve `keepPreviousData` behavior

---

### IMPL: Initial task breakdown
**Time**: 2026-01-13T22:34:44Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T223444Z-TodoWrite-76771-tasks
**Tasks**: 4 (0 done, 1 active, 3 pending)

- [~] Update entities.$cui.tsx loader to return ssrParams
- [ ] Update entities.$cui.lazy.tsx to derive SSR placeholder from cache
- [ ] Update useEntityDetails.ts to accept ssrPlaceholder option
- [ ] Run typecheck to verify no type errors

---

### PROMPT: User input
**Time**: 2026-01-13T22:40:48Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T224048Z-UserPrompt-92027

There seems multiple GetEntityDetails firing when testing locally

---

### PROMPT: User input
**Time**: 2026-01-13T22:43:27Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T224327Z-UserPrompt-97723

[SSR Placeholder] SSR params: RON total
entities.$cui.lazy.tsx:156 [SSR Placeholder] Cache hit: true
entities.$cui.lazy.tsx:155 [SSR Placeholder] SSR params: RON total
entities.$cui.lazy.tsx:156 [SSR Placeholder] Cache hit: true
entities.$cui.lazy.tsx:172 [Client Query] Params: RON total has ssrPlaceholder: true
entities.$cui.lazy.tsx:172 [Client Query] Params: RON total has ssrPlaceholder: true
Error with Feature-Policy header: Some features are specified in both Feature-Policy and Permissio...

---

### PROMPT: User input
**Time**: 2026-01-13T22:45:22Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T224522Z-UserPrompt-1960


entities.$cui.lazy.tsx:156 [2026-01-13T22:45:06.768Z] [SSR Placeholder] SSR queryKey: (2) ['entityDetails', '1e95b5ac']
entities.$cui.lazy.tsx:157 [2026-01-13T22:45:06.768Z] [SSR Placeholder] Cache hit: true
entities.$cui.lazy.tsx:156 [2026-01-13T22:45:06.769Z] [SSR Placeholder] SSR queryKey: (2) ['entityDetails', '1e95b5ac']
entities.$cui.lazy.tsx:157 [2026-01-13T22:45:06.769Z] [SSR Placeholder] Cache hit: true
entities.$cui.lazy.tsx:175 [2026-01-13T22:45:06.769Z] [Client Query] Client quer...

---

### PROMPT: User input
**Time**: 2026-01-13T22:46:42Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T224642Z-UserPrompt-4651

Add it to the logs

---

### PROMPT: User input
**Time**: 2026-01-13T22:47:09Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T224709Z-UserPrompt-5718

I want you to prevent the fade in animation from triggering twice. 

---

### PROMPT: User input
**Time**: 2026-01-13T22:48:50Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T224850Z-UserPrompt-9791

Still triggering twice, once on load and once on client query data load

---

### PROMPT: User input
**Time**: 2026-01-13T22:51:51Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T225151Z-UserPrompt-16005

Navigated to http://localhost:3000/entities/4270740?view=overview&transferFilter=no-transfers
client:733 [vite] connecting...
client:827 [vite] connected.
chunk-V4OQ3NZ2.js:11 Download the React DevTools for a better development experience: https://react.dev/link/react-devtools
entities.$cui.lazy.tsx:157 [2026-01-13T22:51:14.896Z] [SSR Placeholder] SSR queryKey: (2) ['entityDetails', '5db7421e']
entities.$cui.lazy.tsx:158 [2026-01-13T22:51:14.896Z] [SSR Placeholder] Cache hit: true
entities.$...

---

### PROMPT: User input
**Time**: 2026-01-13T22:55:21Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T225521Z-UserPrompt-23032

Fixed default values: DEFAULT_MONTH = '12', DEFAULT_QUARTER = 'Q4' (was '01' and 'Q1'), why? I want the prev one if not a bug in ui. Also, is this the only strategy to do it, or is there a better way?   const ssrPlaceholder = useMemo(() => {
    if (!loaderData?.ssrParams) return undefined
    const ssrQueryOptions = entityDetailsQueryOptions(loaderData.ssrParams)
    return queryClient.getQueryData<EntityDetailsData>(ssrQueryOptions.queryKey)
  // eslint-disable-next-line react-hooks/exhaust...

---

### PROMPT: User input
**Time**: 2026-01-13T22:57:46Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T225746Z-UserPrompt-27940

document that in the decission file /decisions 

---

### AGENT: Used ssrPlaceholder approach for SSR-to-client ent...
**Time**: 2026-01-13T22:58:06Z
**Source**: /decisions log
**Score**: 4
**Decision ID**: 20260113-3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T225806Z-agent-28745
**Context**: Fix entity page flickering on SSR hydration
**Affected files**:
- src/routes/entities..tsx
- src/routes/entities..lazy.tsx
- src/lib/hooks/useEntityDetails.ts

Used ssrPlaceholder approach for SSR-to-client entity data transfer - returns small ssrParams from loader, derives cached entity from rehydrated QueryClient, uses placeholderData function to preserve keepPreviousData. Alternatives considered: cookie/localStorage sync (complex), cookies-only preferences (size limits), initialData (prevents refetch), useSuspenseQuery (less control). Current approach: zero payload duplication, preserves navigation smoothness, allows background refetch.

---

### PROMPT: User input
**Time**: 2026-01-13T22:58:26Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T225826Z-UserPrompt-29781

/commit 

---

### USER: Commit
**Time**: 2026-01-13T23:00:02Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 3ffc7f2b-7cb7-4cd4-96fc-080caec3f701-20260113T230002Z-AskUserQuestion-33320-q1
**Context**: Commit
**Multi-select**: false

**Question**: Ready to commit with this message?

**Options**:
1. **Commit with this message** - Create the commit and link decisions
2. **Edit message** - I'll provide changes to the message
3. **Skip decisions** - Commit without linking decisions
4. **Cancel** - Abort the commit

**Selected**: Commit with this message

---

