---
session_id: "8707403f-c065-45bb-9818-14eeb579629a"
session_id_source: "provided"
created: "2026-01-14T08:07:22Z"
updated: "2026-01-14T12:17:54Z"
status: "active"
commit: ""
topic: ""
tags: []
project_dir: "/Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client"
cwd: "/Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client"
---

# Session Decisions: 8707403f-c065-45bb-9818-14eeb579629a

## Decisions

### PROMPT: User input
**Time**: 2026-01-14T08:07:22Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T080722Z-UserPrompt-83746

Now it's fetching the correct data based on user currency but on SSR it's showing the wrong unit. In my case I'm testing with Euro and it's showing the correct Euro value but the unit is wrong and then switches back to Euro once the client fetches the data again.

---

### PROMPT: User input
**Time**: 2026-01-14T08:25:47Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T082547Z-UserPrompt-37901

The problem now is that I'm trying to change the currency in the client and the client still skips the euro as the currency. So we need a solution that works both on SSR and the client. We have fixed the SSR rendering with the correct currency but now I cannot change the currency. So we need to also fix that and find a solution that's simple, it's solid, well encapsulated and works with all those use cases. So think how we can solve this problem first. ultrathink 

---

### PLAN: Plan: Fix SSR Currency Handling with Client-Side Switching
**Time**: 2026-01-14T08:32:38Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T083238Z-ExitPlanMode-52821-plan
**Plan created**: 2026-01-14T10:27:42Z
**Lines**: 152
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client

**Files**:
- Original: /Users/claudiuconstantinbogdan/.claude/plans/staged-sniffing-tide.md
- Archived: .claude/plans/archived/staged-sniffing-tide-20260114T083238Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client/.claude/plans/archived/staged-sniffing-tide-20260114T083238Z.md

**Summary**:
# Summary

- **Create `useHydratedValue` hook** to track when SSR hydration completes, returning SSR value during hydration (to prevent flicker) and switching to client value after (to allow user changes)
- **Apply hook to currency and inflation preferences** in entity page by calling it unconditionally at the top level, then using returned values in conditional logic
- **Enables all three use cases**: SSR renders correct data, no hydration flicker, and users can switch currencies/preferences after page load

---

### IMPL: Initial task breakdown
**Time**: 2026-01-14T08:32:51Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T083251Z-TodoWrite-54094-tasks
**Tasks**: 3 (0 done, 1 active, 2 pending)

- [~] Create useHydratedValue hook
- [ ] Update entities.$cui.lazy.tsx to use hook
- [ ] Run type checking and tests

---

### PROMPT: User input
**Time**: 2026-01-14T08:38:07Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T083807Z-UserPrompt-67233

I'm also looking for the same strategy for inflation adjusted and global settings. So, I'm thinking if it's possible to have a unified strategy for handling those kind of flags or settings to work with SSR and client correctly. And I also want you to think if we can store that state in the query similar to the language where we set a query lang flag used to share a page with a specific language and also used to server-side rendering if available. And this way we don't depend on cookies anymor...

---

### USER: URL Behavior
**Time**: 2026-01-14T08:50:06Z
**Source**: AskUserQuestion
**Score**: 5
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T085006Z-AskUserQuestion-94894-q1
**Context**: URL Behavior
**Multi-select**: false

**Question**: When a user visits a shared URL like `?currency=EUR`, should the URL parameter stay or be consumed?

**Options**:
1. **Stay (like language)** - URL stays shareable. User preference is ignored while URL param present. Can add 'Save as default' button to apply and clear.
2. **Consume (current)** - URL param is saved to storage then removed. Clean URLs but less shareable - only works once per visit.
3. **Hybrid** - Stay for sharing links, but add a UI option to 'Apply and clear URL' that saves preference and removes param.

**Selected**: it should stay but change if the user changes the currency in the application. It's like storing the state in the URL. We also need a way to make sure we have a source of truth reliable. So if the user deletes the URL, we should store the global settings somewhere else on the client. So yeah, this is a challenge that we need to understand and come up with a good solution. Because if we use the URL as the source of truth, then we have a problem if we use navigations that remove the query. But we also have a problem when we sharing and using server-side rendering if not using the query params. So we need to find a balance here. Best strategy that solves those problems. this needs more clarification.

---

### PROMPT: User input
**Time**: 2026-01-14T09:21:40Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T092140Z-UserPrompt-83031

## Overall assessment

The direction is correct: you’re converging on a single resolution chain that works for SSR, hydration, persistence, and shareable URLs. The main gaps are not conceptual—they’re in the “last mile” details that will determine whether you truly eliminate flicker and whether settings survive navigations/redirects in TanStack Router.

The most important points to address:

1. **Persisted preference must be readable by SSR** (i.e., cookie, not only localStorage), and **must ...

---

### PLAN: Plan: Unified Global Settings System (URL-First, Like Language)
**Time**: 2026-01-14T11:22:33Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T112233Z-ExitPlanMode-38577-plan
**Plan created**: 2026-01-14T13:15:20Z
**Lines**: 620
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client

**Files**:
- Original: /Users/claudiuconstantinbogdan/.claude/plans/staged-sniffing-tide.md
- Archived: .claude/plans/archived/staged-sniffing-tide-20260114T112233Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client/.claude/plans/archived/staged-sniffing-tide-20260114T112233Z.md

**Summary**:
# Summary

- **Unified URL-first settings system**: Create a single `useGlobalSettings` hook that handles currency and inflation_adjusted parameters like language (`?lang=ro`), with URL params as shareable state that persists to cookies
- **SSR-compatible with no flicker**: Server reads from URL+cookies, client hydrates with cookie-only values in React state, syncs URL→cookie only when not forced by route constraints
- **Fix forced overrides**: Routes like `total_euro` force `currency=EUR` and block conflicting URL→cookie sync, while maintaining ability to fall back to user preference when leaving forced routes

---

### IMPL: Initial task breakdown
**Time**: 2026-01-14T11:23:00Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T112300Z-TodoWrite-40766-tasks
**Tasks**: 7 (0 done, 1 active, 6 pending)

- [~] Create src/lib/globalSettings/params.ts shared parsing module
- [ ] Update src/routes/__root.tsx with global search schema
- [ ] Create src/lib/hooks/useGlobalSettings.ts unified hook
- [ ] Update src/routes/entities.$cui.tsx SSR loader
- [ ] Update src/routes/entities.$cui.lazy.tsx to use new hook
- [ ] Delete src/lib/hooks/useHydratedValue.ts
- [ ] Run type checking and fix any errors

---

### PROMPT: User input
**Time**: 2026-01-14T12:04:40Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T120440Z-UserPrompt-90251

ultrathink **Implementation Review**
- Solid consolidation around `useGlobalSettings` and server-derived persistence. Loader computes cookie-only `ssrSettings` and forced overrides cleanly (`src/routes/entities.$cui.tsx:43`).
- Root-level search schema now preserves global params across navigation, which matches the spec (`src/routes/__root.tsx:31`).
- The parsing utilities are concise and reusable (`src/lib/globalSettings/params.ts:1`).

**Potential Issues**
- `shouldPrefetchData` returns ea...

---

### PLAN: Plan: Post-Implementation Improvements for Global Settings
**Time**: 2026-01-14T12:13:05Z
**Source**: ExitPlanMode
**Score**: 4
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T121305Z-ExitPlanMode-25047-plan
**Plan created**: 2026-01-14T14:12:37Z
**Lines**: 215
**Approved in**: /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client

**Files**:
- Original: /Users/claudiuconstantinbogdan/.claude/plans/staged-sniffing-tide.md
- Archived: .claude/plans/archived/staged-sniffing-tide-20260114T121305Z.md
- Archived (full): /Users/claudiuconstantinbogdan/projects/devostack/hack-for-facts-eb-client/.claude/plans/archived/staged-sniffing-tide-20260114T121305Z.md

**Summary**:
I'll summarize this implementation plan in 2-3 concise bullet points:

- **Eliminate duplicated normalization logic** by creating a single `resolveNormalizationSettings()` helper in `src/lib/globalSettings/params.ts` that both the loader and client component use to compute normalization and forced overrides, preventing drift between server and client.

- **Fix stale state and edge cases** by: (1) using TanStack Router's functional search updater to avoid race conditions when updating URL state, and (2) ensuring the prefetch path still reads cookies to return valid `ssrSettings` instead of undefined.

- **Consolidate all settings updates through the hook** so currency/inflation preferences use consistent atomic updates with proper forced override guards across `setSettings()`, `setCurrency()`, and `setInflationAdjusted()`.

---

### IMPL: Initial task breakdown
**Time**: 2026-01-14T12:13:21Z
**Source**: TodoWrite
**Score**: 3
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T121321Z-TodoWrite-26802-tasks
**Tasks**: 5 (0 done, 1 active, 4 pending)

- [~] Add resolveNormalizationSettings helper to params.ts
- [ ] Update loader to use helper and fix prefetch
- [ ] Update client component to use helper
- [ ] Fix search state updates in hook with functional updater
- [ ] Run type checking

---

### PROMPT: User input
**Time**: 2026-01-14T12:17:54Z
**Source**: UserPromptSubmit
**Score**: 1
**Decision ID**: 8707403f-c065-45bb-9818-14eeb579629a-20260114T121754Z-UserPrompt-43616

/commit 

---

